@model PostQuestionViewModel

@{
    ViewData["Title"] = "Ask a Question";
}

<style type="text/css">
    table#postQuestionTable {
        width: 100%;
    }

    table#postQuestionTable td {
        padding: 5px;
    }

    table#postQuestionTable td > label.control-label {
        float: right;
    }

     table#postQuestionTable td input {
        max-width: 100%;
    }

     #tagInputContainer {
         padding: 0;
         height: 56px;
         display: flex;
     }

     #tagInput {
         border: 0;
         height: 100%;
         width: 100%;
         padding: 0 10px;
         background: transparent;
     }
</style>

<script type="text/javascript">
    $(document).ready(function () {
        $("#tagInput").keypress(function (e) {
            if (e.keyCode === 0 || e.keyCode === 32) {
                e.preventDefault();
                var tagNameStr = $(this).val().trim();
                if (tagNameStr.length != 0) {
                    var tagNames = tagNameStr.split(" ");
                    for (var t in tagNames) {
                        var tagName = tagNames[t];
                        if ($(".tag[data-tag-name='" + tagName.toLowerCase() + "']").length == 0) {
                            $newTag = $(document.createElement("span")).addClass("tag").addClass("tag-new").attr("data-tag-name", tagName.toLowerCase()).html(tagName);
                            $newTag.insertBefore(this);
                            var newTagRect = $newTag[0].getBoundingClientRect();
                            var width = newTagRect.width;
                            $(this).css({
                                "margin-left": (parseFloat(window.getComputedStyle(this).marginLeft) - (width + 10)) + "px",
                                "padding-left": (parseFloat(window.getComputedStyle(this).paddingLeft) + (width + ($(".tag").length == 1 ? 0 : 10))) + "px"
                            });

                            window.setTimeout(function () {
                                while ($newTag.children().length > 0) {
                                    if ($newTag != null)
                                        $newTag = $newTag.prev();
                                    else
                                        return;
                                }
                                var oldWidth = $newTag[0].getBoundingClientRect().width;
                                $newTag.append($(document.createElement("a")).attr("href", "javascript:void(0)").html("&nbsp;x").click(deleteTag));
                                var newWidth = $newTag[0].getBoundingClientRect().width;
                                $("#tagInput").css({
                                    "margin-left": (parseFloat(window.getComputedStyle($("#tagInput")[0]).marginLeft) - (newWidth - oldWidth)) + "px",
                                    "padding-left": (parseFloat(window.getComputedStyle($("#tagInput")[0]).paddingLeft) + (newWidth - oldWidth)) + "px"
                                });

                                $.ajax({
                                    type: "POST",
                                    url: 'GetTagForTagName',
                                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                                    data: {
                                        tagName: $newTag.attr("data-tag-name"),
                                        __RequestVerificationToken: $("input[name=__RequestVerificationToken]").val()
                                    },
                                    dataType: "json",
                                    success: function (data) {
                                        if (data[0] > 0) {
                                            $tag = $(".tag[data-tag-name='" + data[1].toLowerCase() + "']");
                                            var oldWidth = $tag[0].getBoundingClientRect().width;
                                            $tag.attr("data-tag-id", data[0]).html(data[1] + $tag.html().slice($tag.html().indexOf("<"))).removeClass("tag-new").children("a").click(deleteTag);
                                            var newWidth = $tag[0].getBoundingClientRect().width;
                                            $("#tagInput").css({
                                                "margin-left": (parseFloat(window.getComputedStyle($("#tagInput")[0]).marginLeft) - (newWidth - oldWidth)) + "px",
                                                "padding-left": (parseFloat(window.getComputedStyle($("#tagInput")[0]).paddingLeft) + (newWidth - oldWidth)) + "px"
                                            });
                                        }
                                    },
                                    error: function () { alert("Error: Something went wrong validating the tag."); }
                                });
                            }, 10);
                        } else {
                            $existingTag = $(".tag[data-tag-name='" + tagName.toLowerCase() + "']");
                            $existingTag.detach().insertBefore("#tagInput");
                        }
                    }
                }
                $(this).val("");
            }
        }).keydown(function (e) {
            if (e.keyCode == 8 && $(this).val().length == 0 && $(".tag").length != 0) {
                $deletedTag = $(this).prev();
                var width = $deletedTag[0].getBoundingClientRect().width;
                $(this).css({
                    "margin-left": (parseFloat(window.getComputedStyle(this).marginLeft) + width + 10) + "px",
                    "padding-left": (parseFloat(window.getComputedStyle(this).paddingLeft) - (width + ($(".tag").length == 1 ? 0 : 10))) + "px"
                });
                $deletedTag.remove();
            }
        });

    });

    function deleteTag() {
        $deletedTag = $(this).parent();
        console.log($deletedTag);
        var width = $deletedTag[0].getBoundingClientRect().width;
        $("#tagInput").css({
            "margin-left": (parseFloat(window.getComputedStyle($("#tagInput")[0]).marginLeft) + width + 10) + "px",
            "padding-left": (parseFloat(window.getComputedStyle($("#tagInput")[0]).paddingLeft) - (width + ($(".tag").length == 1 ? 0 : 10))) + "px"
        });
        $deletedTag.remove();
    }
</script>

<div class="row">
    <div class="col-md-12">
        <h2 class="center">@ViewData["Title"]</h2>
            
        <hr />

        @using (Html.BeginForm("Home", "PostQuestion"))
        {
            <div asp-validation-summary="All" class="text-danger"></div>
            <table id="postQuestionTable">
                <tr>
                    <td width="10%">
                        <label asp-for="Summary" class="control-label"></label>
                    </td>
                    <td width="90%">
                        <input asp-for="Summary" type="text" class="form-control" />
                    </td>
                </tr>
                <tr>
                    <td>
                        <label asp-for="Content" class="control-label"></label>
                    </td>
                    <td>
                        <textarea asp-for="Content" name="Contents"></textarea>
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><hr /></td>
                </tr>
                <tr>
                    <td>
                        <label for="Preview" class="control-label">Preview</label>
                    </td>
                    <td>
                        <div id="Preview"></div>
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><hr /></td>
                </tr>
                <tr>
                    <td>
                        <label asp-for="Tags" class="control-label left"></label>
                    </td>
                    <td>
                        <div id="tagInputContainer" class="form-control">
                            <input id="tagInput" type="text" maxlength="40">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><hr /></td>
                </tr>
                <tr>
                    <td colspan="2" class="center">
                        <button type="submit" class="btn btn-lg btn-primary">Post Question</button>
                    </td>
                </tr>
            </table>
        }
    </div>
</div>

<script src="~/js/inittexteditors.js"></script>